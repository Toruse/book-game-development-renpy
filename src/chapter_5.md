# Глава 5. Погружаемся глубже

Дойдя до этой главы, вы уже усвоили базовые теоретические и практические знания по _Ren’Py_, _Twine_ и _TyranoBuilder_. 
Теперь познакомимся с более сложными инструментами, которые имеются в рассматриваемом программном обеспечении. Например, 
разберём, как интегрировать видео в Ren’Py, как улучшить игры на Twine при помощи каскадных таблиц стилей (CSS), и как 
создать произвольный диалог в TyranoBuilder.

## Ren’Py, контейнеры и кодеки

Информация о форматах видео, по сути, не касается Ren’Py, TyranoBuilder или Twine, но она может оказаться полезной при 
работе с аудиовизуальными эффектами в проекте.

Видео (и аудио) файл обычно состоит из двух компонентов это контейнер и кодек. Контейнер — это файл, который содержит 
в себе видео, аудио и субтитры. В свою очередь кодек является инструментом для сжатия и распаковки видеофайла внутри 
контейнера. Существует многое количество кодеков, которые различаются между собой качеством и коэффициентом сжатия. 
Самыми популярными форматы контейнеров являются _.ogg_, _.webm_ и _.avi_, и соответственно они имеют поддержку на многих 
платформах как на настольных, так и на мобильных.

Что касается кодеков, то хорошим выбором является _H.264_ (известный как _MPEG-4_), _MPEG-2_ и _MPEG-1_. Данный формат 
был разработан в 1988 году _Хироси Ясудой_ и _Леонардо Кьярильоне_, а аббревиатура _MPEG (Moving Picture Experts Group)_ 
расшифровывается как _Экспертная группа по движущимся изображениям_.

Давайте, используя таблицу 5-1, сравним самые распространённые кодеки:

__Таблица 5-1.__ Наиболее распространенные видеокодеки

| Кодек                                       | Лицензия                                                     | Дата релиза | Особенности                                                                                                                                                  |
|---------------------------------------------|--------------------------------------------------------------|-------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| _VP9_                                       | Свободная                                                    | 2012        | Поддержка видео высокого разрешения (например, 4K/8K UHD), опция сжатия без потерь                                                                           |
| _VP8_                                       | Свободная                                                    | 2008        | Поддержка многопроцессорности. Свободный доступ для редактирования видео. Лучше всего использовать для видео с низким разрешением                            |
| _Theora_                                    | Свободная                                                    | 2004        | Поддерживает потоковую передачу видео через Интернет, достоянная картинка при низком битрейте                                                                |
| _H.264 (MPEG-4)_                            | Бесплатная для использования в Интернете                     | 2003        | Эффективен для потокового видео через Интернет, поддерживает разрешение до 8192 × 4320 (включая 8K UHD)                                                      |
| _Xvid, бесплатная реализация MPEG-4 part 2_ | Свободная (Универсальная общественная лицензия GNU)          | 2001        | Оптимизирована производительность, широкая поддержка                                                                                                         |
| _MPEG-2_                                    | Все американские патенты MPEG-2 истекли 13 февраля 2019 года | 1996        | Формат золотой стандарт DVD, может включать объемный звук 5.1                                                                                                |
| _MPEG-1_                                    | Свободная (срок действия патентов истек)                     | 1989        | Хорошо работает с видео с низким битрейтом (например, для небольших дисплеев), принимая во внимание как качество изображения, так и небольшой размер файла.  |

Теперь при помощи таблицы 5-2 сравним форматы контейнеров:

__Таблица 5-2.__ Наиболее распространенные видео контейнеры

| Формат контейнера                            | Лицензия               | Дата релиза | Поддерживаемые кодеки                                                               |
|----------------------------------------------|------------------------|-------------|-------------------------------------------------------------------------------------|
| _WebM_                                       | Свободная              | 2010        | Видео VP8 и VP9, аудио Ogg Vorbis и Opus audio                                      |
| _Matroska_                                   | Свободная              | 2002        | Любой                                                                               |
| _Ogg_                                        | Свободная              | 1993        | Видео Theora и Dirac. Аудио Opus, Vorbis и Speex                                    |
| _MPEG-контейнер (не путать с MPEG-кодеками)_ | Ограниченна            | 1993        | Видео MPEG-1 и MPEG-2. Аудио MPEG-1 Layers 1, 2, и 3 (то есть mp3)                  |
| _AVI_                                        | Относительно свободная | 1992        | В основном содержит несжатое видео (Full Frame), Intel Real Time (Indeo) и Cinepak  |

### Видео в Ren’Py

Воспроизвести видео в Ren’Py относительно простая задача. Благодаря поддержке нескольких широко распространённых 
видеоформатов, вам не придётся прибегать к трудному процессу преобразованию видео из одного формата в другой. 

Следующая строка кода, добавленная в сценарий, воспроизведёт видео во весь размер окна игры:

``` python
$ renpy.movie_cutscene("introvideo.webm")
```

Видео будет проигрываться до тех пор, пока не достигнет своего конца или пока игрок не щелкнет мышью. Но этим Ren’Py 
не ограничивается. Вы можете использовать видео как фон или как изображение персонажа. 

Давайте рассмотрим пример:

``` python
    image markus movie = Movie(play="markus_movie.webm", mask="markus_mask.webm")
    show markus movie
    "Разве это не весело?"
    hide markus movie
```

Данный код в первой строке определяет _видео спрайт_ (_movie sprite_) с именем "markus", которому присваивается 
видеофайл _markus_movie.webm_. Далее командой show воспроизводиться видео. Потом выводиться диалог, а затем видео 
скрывается командой hide.

Как мы знаем видео имеет квадратную или прямоугольную форму и не имеет прозрачности. Чтобы скрыть нежелательные края 
или фон в видео спрайте во время вызова метода Movie указывается параметр _mask_ (_маска_). _Маска_ – это видео такого 
же размера и продолжительности, что и видео, с которым она связана.

Что касается Ren’Py, то в маске белый цвет обозначает видимую область, а черный — область, которую нужно скрыть.

### Расширенные функции аудио в Ren’Py

Во время разработки игры возникает потребность одновременно воспроизводить фоновую музыку, звуковые эффекты, голоса 
персонажей. Для это в Ren'Py используется подход, при котором один аудиоканал используется для воспроизведения музыки, 
второй для звука, и ещё один для голоса. Каждый из этих каналов воспроизводит по одному аудиофайлу за раз. Если вам 
потребуется дополнительный аудиоканал вы можете его создать. Как это сделать будет показано далее в книге.

Нижеприведённом примере используются сразу все три канала для одновременного воспроизведения песни, звукового эффекта 
и диалога.

``` python
    play music "song1.ogg"
    play sound "boom.mp3"
    voice "dialogue1.ogg"
    "Привет, как ты?"
```

Ren’Py поддерживает _.wav_, _.ogg_, _.mp3_ и _Opus_ форматы. Из них формат .wav (который является стандартным аудио 
форматом для компакт-дисков), пожалуй, самый громоздкий, так как не имеет сжатия, его не рекомендуется для использования 
в релизной версии игры. Никто не любит, когда игра занимает много дискового пространства, а особенно когда она 
распространяется через Интернет (то есть будет долго загружаться). Наилучшее применение .wav формата – это когда звук 
находится на стадии обработки, и только после выполнения всех работ, его можно сохранить в формат с элементом сжатие. 
Имейте виду, при сжатии идёт потеря качества аудиодорожки, в результате вы получаете копию, а не оригинал. Если это 
повторить несколько раз, то качество звука сильно упадёт.

#### Аудио очереди

Игра будет более приятно восприниматься, когда в место одной короткой повторяющейся мелодии будет плейлист с 
разнообразной музыкой. Это можно легко сделать в Ren’Py при помощи метода _queue_. В примере показано, как создается 
очередь из трех мелодий (в формате .ogg) для музыкального канала.

``` python
queue music [ "song1.ogg", "song2.ogg", "happysong.ogg" ]
```

#### Параметры операторов воспроизведения и остановки

Оператор play не ограничивается простым открытием файла и его воспроизведением. Например, вы можете передать в него 
очередь аудиофайлов, задать затухание в начале и в конце.

``` python
play music [ "song1.mp3", "song2.mp3" ] fadeout 2.0 fadein 2.0
```

Если вы хотите остановить воспроизведение музыкального канала с затуханием длиной в 10 секунд, то нужно в операторе 
stop указать следующие параметры:

``` python
stop music fadeout 10.0
```

Если вам когда-нибудь понадобится вставить паузу перед воспроизведением, то воспользуйтесь тегом silence (тишина) с 
параметром длительность тишины в секундах.

``` python
play audio [ "<silence 2.5>", "song1.mp3" ]
```

#### Воспроизводим произвольную часть аудиофайла

